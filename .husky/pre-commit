#!/bin/bash

# Husky pre-commit hook
# Validates JSON, shell scripts, and YAML frontmatter before commits

echo "üîç Running pre-commit validation..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  echo "‚úÖ No files staged for commit"
  exit 0
fi

# JSON validation
echo "üìÑ Validating JSON files..."
JSON_FILES=$(echo "$STAGED_FILES" | grep -E '\.(json)$' | grep -v '.git/' | grep -v 'node_modules/')

if [ -n "$JSON_FILES" ]; then
  JSON_ERRORS=0
  while IFS= read -r file; do
    if [ -f "$file" ]; then
      if ! jq -e . "$file" >/dev/null 2>&1; then
        echo "‚ùå JSON validation failed: $file"
        JSON_ERRORS=$((JSON_ERRORS + 1))
      else
        echo "   ‚úì $file"
      fi
    fi
  done <<< "$JSON_FILES"

  if [ $JSON_ERRORS -gt 0 ]; then
    echo ""
    echo "‚ùå $JSON_ERRORS JSON file(s) failed validation"
    echo "   Fix syntax errors and try again"
    echo "   Tip: Run 'jq . <file>' to see specific errors"
    exit 1
  fi
fi

# Shell script validation
echo "üêö Validating shell scripts..."
SHELL_FILES=$(echo "$STAGED_FILES" | grep -E '\.(sh)$')

if [ -n "$SHELL_FILES" ]; then
  SHELL_ERRORS=0
  while IFS= read -r file; do
    if [ -f "$file" ]; then
      if ! bash -n "$file" 2>&1; then
        echo "‚ùå Shell script syntax error: $file"
        SHELL_ERRORS=$((SHELL_ERRORS + 1))
      else
        echo "   ‚úì $file"

        # Check if hook scripts are executable
        if echo "$file" | grep -q "hooks/scripts/"; then
          if [ ! -x "$file" ]; then
            echo "‚ùå Hook script not executable: $file"
            echo "   Run: chmod +x $file"
            SHELL_ERRORS=$((SHELL_ERRORS + 1))
          fi
        fi
      fi
    fi
  done <<< "$SHELL_FILES"

  if [ $SHELL_ERRORS -gt 0 ]; then
    echo ""
    echo "‚ùå $SHELL_ERRORS shell script(s) failed validation"
    exit 1
  fi
fi

# YAML frontmatter validation
echo "üìù Validating YAML frontmatter in markdown files..."
MD_FILES=$(echo "$STAGED_FILES" | grep -E '\.(md)$')

if [ -n "$MD_FILES" ]; then
  YAML_ERRORS=0
  while IFS= read -r file; do
    if [ -f "$file" ]; then
      # Check if file has frontmatter
      if head -1 "$file" | grep -q "^---$"; then
        # Check for closing ---
        if ! sed -n '2,20p' "$file" | grep -q "^---$"; then
          echo "‚ùå YAML frontmatter not properly closed: $file"
          YAML_ERRORS=$((YAML_ERRORS + 1))
        else
          echo "   ‚úì $file"
        fi
      fi
    fi
  done <<< "$MD_FILES"

  if [ $YAML_ERRORS -gt 0 ]; then
    echo ""
    echo "‚ùå $YAML_ERRORS markdown file(s) have invalid frontmatter"
    echo "   Ensure frontmatter starts and ends with '---'"
    exit 1
  fi
fi

echo ""
echo "‚úÖ Pre-commit validation passed"
exit 0
